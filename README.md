# FFT4CM4F

This is a collection of FFT routines for the Cortex-M4 Processor with FPU, aka M4F.

It is based on djbfft from D.J.Bernstein, which in 1999 was the fastest FFT for processors without a SIMD unit such as SSE, Altivec or Neon. This makes it an ideal choice for Cortex-M4F, which comes with an FPU but no SIMD. 
The original is still here: https://cr.yp.to/djbfft.html


Also, I found the available CMSIS provided FFT routines slow and awkward to use, in addition to  strange results and polluted memory.

Although fast and easy to use, outputs from forward transforms are not bitreversed but come with a strange permutation. I have not yet managed to find a formal solution to generate permutation tables for this, other than checking transform outputs for given inputs. However, the inverse transforms expect the same order, so for some tasks like convolution, there is no need to permute.

It contains gcc style inline assembly, so it might not work for some compilers.

This is a work in progress, but since it is useful for me at this stage, it might be so for others. 

License is the same as the original djbfft, which is in the public domain.

For benchmarking, I ran tests on a STM32F466 MCU against the CMSIS routines, all without bitreversing. 


Here the results for real transforms, r+ indicates forward, r- inverse transform:


|real|cycles|performance (N * log2(N)/cycles) |
|-|-|-|
|16 r+ CMSIS_5|446122|bug?|
|16 r+ FFT4CM4F|219|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|16 r- CMSIS_5|446651|something weird going on here as well.|
|16 r- FFT4CM4F|210|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|32 r+ CMSIS_5|1794|:::::::::::::::::::::::::::::::::::::|
|32 r+ FFT4CM4F|640|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|32 r- CMSIS_5|2186|::::::::::::::::::::::::::::::|
|32 r- FFT4CM4F|638|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|64 r+ CMSIS_5|3831|::::::::::::::::::::::::::::::::::::::::::|
|64 r+ FFT4CM4F|1607|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|64 r- CMSIS_5|4583|:::::::::::::::::::::::::::::::::::|
|64 r- FFT4CM4F|1615|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|128 r+ CMSIS_5|7167|::::::::::::::::::::::::::::::::::::::::::::::::::::|
|128 r+ FFT4CM4F|3801|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|128 r- CMSIS_5|8670|:::::::::::::::::::::::::::::::::::::::::::|
|128 r- FFT4CM4F|3888|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|256 r+ CMSIS_5|16515|::::::::::::::::::::::::::::::::::::::::::::::::::::|
|256 r+ FFT4CM4F|8765|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|256 r- CMSIS_5|19479|::::::::::::::::::::::::::::::::::::::::::::|
|256 r- FFT4CM4F|8949|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|512 r+ CMSIS_5|37378|:::::::::::::::::::::::::::::::::::::::::::::::::::|
|512 r+ FFT4CM4F|19979|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|512 r- CMSIS_5|43282|::::::::::::::::::::::::::::::::::::::::::::|
|512 r- FFT4CM4F|20390|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|1024 r+ CMSIS_5|66860|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|1024 r+ FFT4CM4F|45057|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|1024 r- CMSIS_5|78654|::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|1024 r- FFT4CM4F|45945|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|2048 r+ CMSIS_5|156371|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|2048 r+ FFT4CM4F|100454|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|2048 r- CMSIS_5|179935|::::::::::::::::::::::::::::::::::::::::::::::::::::|
|2048 r- FFT4CM4F|102221|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|4096 r+ CMSIS_5|341813|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|4096 r+ FFT4CM4F|221688|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|4096 r- CMSIS_5|388940|:::::::::::::::::::::::::::::::::::::::::::::::::::::|
|4096 r- FFT4CM4F|225242|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|


Here the same for complex transforms - note that for size 4096, CMSIS scores one point.


|complex|cycles|performance (N * log2(N)/cycles) |
|-|-|-|
|16 c+ CMSIS_5|875|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|16 c+ FFT4CM4F|428|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|16 c- CMSIS_5|1106|:::::::::::::::::::::::::::::::::::::::::::::::::|
|16 c- FFT4CM4F|445|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|32 c+ CMSIS_5|2053|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|32 c+ FFT4CM4F|1297|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|32 c- CMSIS_5|2501|::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|32 c- FFT4CM4F|1308|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|64 c+ CMSIS_5|4028|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|64 c+ FFT4CM4F|3135|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|64 c- CMSIS_5|4542|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|64 c- FFT4CM4F|3214|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|128 c+ CMSIS_5|9582|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|128 c+ FFT4CM4F|7479|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|128 c- CMSIS_5|11308|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|128 c- FFT4CM4F|7687|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|256 c+ CMSIS_5|23368|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|256 c+ FFT4CM4F|17599|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|256 c- CMSIS_5|27001|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|256 c- FFT4CM4F|18000|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|512 c+ CMSIS_5|42387|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|512 c+ FFT4CM4F|40440|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|512 c- CMSIS_5|46085|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|512 c- FFT4CM4F|41167|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|1024 c+ CMSIS_5|100215|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|1024 c+ FFT4CM4F|91366|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|1024 c- CMSIS_5|114882|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|1024 c- FFT4CM4F|92755|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|2048 c+ CMSIS_5|227900|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|2048 c+ FFT4CM4F|203660|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|2048 c- CMSIS_5|258873|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|2048 c- FFT4CM4F|206574|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|4096 c+ CMSIS_5|417639|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|4096 c+ FFT4CM4F|449353|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|4096 c- CMSIS_5|449942|:::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|
|4096 c- FFT4CM4F|455123|::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::|




